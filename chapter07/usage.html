<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="application/xhtml+xml; charset=utf-8" />
    <title>
      7.7.&nbsp;引导脚本如何工作？
    </title>
    <link rel="stylesheet" href="../stylesheets/lfs.css" type="text/css" />
    <meta name="generator" content="DocBook XSL Stylesheets V1.73.2" />
    <link rel="stylesheet" href="../stylesheets/lfs-print.css" type=
    "text/css" media="print" />
  </head>
  <body class="lfs" id="lfs-SVN-20121122">
    <div class="navheader">
      <h4>
        Linux From Scratch - 版本 SVN-20121122
      </h4>
      <h3>
        第&nbsp;7&nbsp;章&nbsp;设置系统引导脚本
      </h3>
      <ul>
        <li class="prev">
          <a accesskey="p" href="bootscripts.html" title=
          "LFS-Bootscripts-20121013">上一页</a>
          <p>
            LFS-Bootscripts-20121013
          </p>
        </li>
        <li class="next">
          <a accesskey="n" href="hostname.html" title="配置系统主机名">下一页</a>
          <p>
            配置系统主机名
          </p>
        </li>
        <li class="up">
          <a accesskey="u" href="chapter07.html" title=
          "第&nbsp;7&nbsp;章&nbsp;设置系统引导脚本">上一级</a>
        </li>
        <li class="home">
          <a accesskey="h" href="../index.html" title=
          "Linux From Scratch - 版本 SVN-20121122">起始页</a>
        </li>
      </ul>
    </div>
    <div class="sect1" lang="zh-cn" xml:lang="zh-cn">
      <h1 class="sect1">
        <a id="ch-scripts-usage" name="ch-scripts-usage"></a>7.7. 引导脚本如何工作？
      </h1>
      <p>
        Linux 使用一种特殊的引导工具，名为 SysVinit，基于 <span class=
        "emphasis"><em>运行级别</em></span> 的概念。他在不同系统上差异可能会很大，所以不要认为某个 Linux
        发行版上能够工作的在 LFS 上就一定能够工作。LFS 处理问题有自己的方式，但遵守广泛接受的标准。
      </p>
      <p>
        SysVinit (以下简称 “<span class="quote">init</span>”) 使用运行级别的方式工作。有 7 种
        (编号为 0 到 6) 运行级别 (其实有更多，但只用于特殊情况，通常并不使用。更多细节参见 <code class=
        "filename">init(8)</code>)，每个都对应计算机在它启动时要进行的动作。默认运行级别为
        3。以下列出不同运行级别实现的描述：
      </p>
      <div class="literallayout">
        <p>
          0：关闭计算机<br />
          1：单用户模式<br />
          2：不带网络的多用户模式<br />
          3：带网络的多用户模式<br />
          4：保留，用于自定义，否则与&nbsp;3&nbsp;相同<br />
          5：与&nbsp;4&nbsp;相同，但通常用于&nbsp;GUI&nbsp;登录&nbsp;(如&nbsp;X&nbsp;的&nbsp;<span class="command"><strong>xdm</strong></span>&nbsp;或者&nbsp;KDE&nbsp;的&nbsp;<span class="command"><strong>kdm</strong></span>)<br />

          6：重新引导计算机
        </p>
      </div>
      <div class="configuration" lang="zh-cn" xml:lang="zh-cn">
        <h2 class="sect2">
          <a id="conf-sysvinit" name="conf-sysvinit"></a>7.7.1. 配置 Sysvinit
        </h2>
        <p>
          在内核初始化过程中，第一个要运行的程序如不再命令行中指定，默认为 <span class=
          "command"><strong>init</strong></span>。此程序读取初始化文件 <code class=
          "filename">/etc/inittab</code>。如此创建之：
        </p>
        <pre class="userinput">
<kbd class="command">cat &gt; /etc/inittab &lt;&lt; "EOF"
<code class="literal"># Begin /etc/inittab

id:3:initdefault:

si::sysinit:/etc/rc.d/init.d/rc S

l0:0:wait:/etc/rc.d/init.d/rc 0
l1:S1:wait:/etc/rc.d/init.d/rc 1
l2:2:wait:/etc/rc.d/init.d/rc 2
l3:3:wait:/etc/rc.d/init.d/rc 3
l4:4:wait:/etc/rc.d/init.d/rc 4
l5:5:wait:/etc/rc.d/init.d/rc 5
l6:6:wait:/etc/rc.d/init.d/rc 6

ca:12345:ctrlaltdel:/sbin/shutdown -t1 -a -r now

su:S016:once:/sbin/sulogin

1:2345:respawn:/sbin/agetty --noclear tty1 9600
2:2345:respawn:/sbin/agetty tty2 9600
3:2345:respawn:/sbin/agetty tty3 9600
4:2345:respawn:/sbin/agetty tty4 9600
5:2345:respawn:/sbin/agetty tty5 9600
6:2345:respawn:/sbin/agetty tty6 9600

# End /etc/inittab</code>
EOF</kbd>
</pre>
        <p>
          对此文件的解释位于 <span class="emphasis"><em>inittab</em></span> 的手册页中。对于
          LFS，运行的核心命令是 <span class=
          "command"><strong>rc</strong></span>。以上的初始化文件将会要求 <span class=
          "command"><strong>rc</strong></span> 运行 <code class=
          "filename">/etc/rc.d/rcsysinit.d</code> 目录中所有以 S 开头的脚本，然后是
          <code class="filename">/etc/rc.d/rc?.d</code> 目录中所有以 S 开头的脚本，其中问号由
          initdefault 的值指定。
        </p>
        <p>
          出于方便考虑，<span class="command"><strong>rc</strong></span> 脚本读取
          <code class="filename">/lib/lsb/init-functions</code>
          中的功能库。此库还读取可选的配置文件 <code class=
          "filename">/etc/sysconfig/rc.site</code>。之前几节中描述的任何系统配置文件参数都可以置于此文件中，使得所有的系统参数合并在这一个文件中。
        </p>
        <p>
          出于调试方便考虑，功能脚本还将所有输出以日志的形式记录于 <code class=
          "filename">/run/var/bootlog</code> 中。由于 <code class=
          "filename">/run</code> 目录是一个
          tmpfs，此文件在重新引导过后不会保留，然而它在引导结束时会被附加到一个更稳定的文件 <code class=
          "filename">/var/log/boot.log</code> 之后。
        </p>
      </div>
      <div class="sect2" lang="zh-cn" xml:lang="zh-cn">
        <h2 class="sect2">
          <a id="init-levels" name="init-levels"></a>7.7.2. 改变运行级别
        </h2>
        <p>
          改变运行级别通过 <span class="command"><strong>init <em class=
          "replaceable"><code>&lt;level&gt;</code></em></strong></span> 完成，其中
          <em class="replaceable"><code>&lt;level&gt;</code></em>
          就是目标运行级别了。例如要重新引导计算机，用户可以执行 <span class="command"><strong>init
          6</strong></span> 命令，也就是 <span class=
          "command"><strong>reboot</strong></span> 命令的别名。相似地， <span class=
          "command"><strong>init 0</strong></span> 也是 <span class=
          "command"><strong>halt</strong></span> 的别名。
        </p>
        <p>
          在 <code class="filename">/etc/rc.d</code> 和 <code class=
          "filename">rcsysinit.d</code> 中有一些与 <code class=
          "filename">rc?.d</code> 相似的目录 (其中问号是运行级别号码)，都包含一些符号链接，有些以
          <span class="emphasis"><em>K</em></span> 开头，其他的以 <span class=
          "emphasis"><em>S</em></span> 开头，在开头字母之后都有两位数字。K 代表停止 (kill) 服务，S
          代表开始服务。数字表示脚本的运行顺序，从 00 到 99——数字越小执行越早。当 <span class=
          "command"><strong>init</strong></span>
          切换至另一个运行级别时，对应的服务就会开始或者停止，这取决于选定的运行级别。
        </p>
        <p>
          真实的脚本位于 <code class=
          "filename">/etc/rc.d/init.d</code>。它们完成实际工作，符号链接也指向它们。K 链接和 S 链接都指向
          <code class="filename">/etc/rc.d/init.d</code> 中的同一个脚本，这是因为这些脚本可以带有
          <em class="parameter"><code>start</code></em>、<em class=
          "parameter"><code>stop</code></em>、<em class=
          "parameter"><code>restart</code></em>、<em class=
          "parameter"><code>reload</code></em> 和 <em class=
          "parameter"><code>status</code></em> 这些参数调用。当遇到 K 的时候，对应的脚本被带
          <em class="parameter"><code>stop</code></em> 参数调用。当遇到 S 的时候，对应的脚本被带
          <em class="parameter"><code>start</code></em> 参数调用。
        </p>
        <p>
          这个解释有一个例外。在 <code class="filename">rc0.d</code> 和 <code class=
          "filename">rc6.d</code> 中的以 <span class=
          "emphasis"><em>S</em></span> 开头的链接不会开始任何服务。他们会以 <em class=
          "parameter"><code>stop</code></em>
          参数调用，来停止服务。它背后的逻辑是用户要重新引导或者关闭系统，没有什么需要开始的，系统正要终止。
        </p>
        <p>
          以下介绍这些参数使得脚本进行的操作：
        </p>
        <div class="variablelist">
          <dl>
            <dt>
              <span class="term"><em class=
              "parameter"><code>start</code></em></span>
            </dt>
            <dd>
              <p>
                服务被开始。
              </p>
            </dd>
            <dt>
              <span class="term"><em class=
              "parameter"><code>stop</code></em></span>
            </dt>
            <dd>
              <p>
                服务被停止。
              </p>
            </dd>
            <dt>
              <span class="term"><em class=
              "parameter"><code>restart</code></em></span>
            </dt>
            <dd>
              <p>
                服务先被停止然后被重新开始。
              </p>
            </dd>
            <dt>
              <span class="term"><em class=
              "parameter"><code>reload</code></em></span>
            </dt>
            <dd>
              <p>
                服务的配置被更新。此项在服务的配置文件经过修改，却无需重新开始之的时候使用。
              </p>
            </dd>
            <dt>
              <span class="term"><em class=
              "parameter"><code>status</code></em></span>
            </dt>
            <dd>
              <p>
                输出服务是否在运行，若在运行则输出 PID。
              </p>
            </dd>
          </dl>
        </div>
        <p>
          你可以自由修改引导脚本工作的方式 (无论如何这是你自己的 LFS 系统)。此处给出的文件只是完成此任务的一个例子。
        </p>
      </div>
    </div>
    <div class="navfooter">
      <ul>
        <li class="prev">
          <a accesskey="p" href="bootscripts.html" title=
          "LFS-Bootscripts-20121013">上一页</a>
          <p>
            LFS-Bootscripts-20121013
          </p>
        </li>
        <li class="next">
          <a accesskey="n" href="hostname.html" title="配置系统主机名">下一页</a>
          <p>
            配置系统主机名
          </p>
        </li>
        <li class="up">
          <a accesskey="u" href="chapter07.html" title=
          "第&nbsp;7&nbsp;章&nbsp;设置系统引导脚本">上一级</a>
        </li>
        <li class="home">
          <a accesskey="h" href="../index.html" title=
          "Linux From Scratch - 版本 SVN-20121122">起始页</a>
        </li>
      </ul>
    </div>
  </body>
</html>
